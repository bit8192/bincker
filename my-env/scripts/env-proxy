#!/usr/bin/env bash
cfg_files=("$HOME/.config/clash/config.yaml" "$HOME/.config/mihomo/config.yaml" "/etc/mihomo/config.yaml" "/etc/clash/config.yaml" "/etc/clash-meta/config.yaml")
for cfg in "${cfg_files[@]}"; do
  if [ -f "$cfg" ]; then
    mihomo_cfg_file="$cfg"
    break
  fi
done

if [ -z "$mihomo_cfg_file" ] || [ ! -f "$mihomo_cfg_file" ]; then
  echo "mihomo config file not found." >&2
  exit 1
fi

port="$(grep "mixed-port:" "$mihomo_cfg_file" | awk '{print $2}')"
if [ -z "$port" ]; then
  port="$(grep "socks-port:" "$mihomo_cfg_file" | awk '{print $2}')"
fi
if [ -z "$port" ]; then
  echo "port not found in config file: $mihomo_cfg_file" >&2
  exit 1
fi

export http_proxy="socks5://127.0.0.1:$port"
export HTTP_PROXY="socks5://127.0.0.1:$port"
export https_proxy="socks5://127.0.0.1:$port"
export HTTPS_PROXY="socks5://127.0.0.1:$port"
export ftp_proxy="socks5://127.0.0.1:$port"
export FTP_PROXY="socks5://127.0.0.1:$port"
export no_proxy="localhost,.local,.internal,127.0.0.1,10.0.0.0/8,192.168.0.0/16,172.16.0.0/12"
